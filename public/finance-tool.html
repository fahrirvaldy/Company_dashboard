<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Planner (Autosave Aktif)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- html2canvas -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        .hidden-section { display: none; }
        
        .capture-area {
            background-color: #ffffff;
            padding: 40px;
        }

        /* Status Simpan Kecil */
        .saving-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9); /* Emerald color for success feel */
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 9999;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .saving-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Animasi Input Sebagian */
        .partial-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .partial-container.show {
            max-height: 60px; /* Cukup untuk input field */
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen py-8 px-4 flex flex-col items-center">

    <!-- Indikator Simpan / Status -->
    <div id="saveIndicator" class="saving-indicator">
        <i class="ph ph-check-circle"></i> <span id="saveText">Disimpan otomatis...</span>
    </div>

    <!-- HEADER -->
    <header class="text-center mb-6 max-w-2xl">
        <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Finance Input Keeper</h1>
        <p class="text-slate-500 mt-2 text-sm">
            <span class="bg-emerald-100 text-emerald-800 px-2 py-0.5 rounded text-xs font-bold border border-emerald-200">AUTOSAVE ON</span> 
            Data Anda aman. Tutup browser kapan saja, data akan kembali saat dibuka.
        </p>
    </header>

    <!-- ======================================================================= -->
    <!-- INPUT SECTION -->
    <!-- ======================================================================= -->
    <section id="inputSection" class="w-full max-w-7xl bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden mb-10">
        <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
            <h2 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                <i class="ph ph-keyboard text-emerald-600 text-xl"></i> Form Input Data
            </h2>
            <button onclick="resetEverything()" class="text-xs text-rose-500 hover:text-rose-700 font-semibold underline decoration-dotted flex items-center gap-1">
                <i class="ph ph-trash"></i> Hapus & Mulai Baru
            </button>
        </div>
        
        <div class="p-6 space-y-6">
            <!-- Tanggal -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Dari Tanggal</label>
                    <input type="date" id="startDate" class="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Sampai Tanggal</label>
                    <input type="date" id="endDate" class="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none transition">
                </div>
            </div>

            <!-- Dana Input Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-slate-100">
                <div class="bg-emerald-50/50 p-4 rounded-lg border border-emerald-100">
                    <label class="block text-xs font-bold uppercase text-emerald-700 mb-1">
                        <i class="ph ph-wallet"></i> Total Dana Awal (Gaji/Tabungan)
                    </label>
                    <input type="text" id="currentFunds" class="w-full p-2.5 bg-white border border-emerald-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none font-mono text-emerald-700 font-bold" placeholder="Rp 0">
                    <p class="text-[10px] text-emerald-600 mt-1 italic">*Masukkan total uang yang tersedia untuk periode ini.</p>
                </div>
                <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100">
                    <label class="block text-xs font-bold uppercase text-blue-700 mb-1">
                        <i class="ph ph-trend-up"></i> Estimasi Tambahan Dana
                    </label>
                    <input type="text" id="incomingFunds" class="w-full p-2.5 bg-white border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-blue-700 font-bold" placeholder="Rp 0">
                </div>
            </div>

            <!-- Tabel Input -->
            <div class="border border-slate-200 rounded-lg overflow-hidden">
                <div class="bg-slate-100 p-3 flex justify-between items-center border-b border-slate-200">
                    <span class="text-sm font-bold text-slate-700">Daftar Transaksi / Tagihan</span>
                    <button type="button" id="btnAddRow" class="text-xs bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-semibold py-1.5 px-3 rounded shadow-sm flex items-center gap-1">
                        <i class="ph ph-plus font-bold"></i> Tambah Baris
                    </button>
                </div>
                
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-500 font-semibold text-xs uppercase">
                        <tr>
                            <th class="px-3 py-3 w-[5%] text-center">#</th>
                            <th class="px-3 py-3 w-[15%]">Tanggal</th>
                            <th class="px-3 py-3 w-[25%]">Nama Pembayaran</th>
                            <th class="px-3 py-3 w-[15%]">Kategori</th>
                            <th class="px-3 py-3 w-[15%]">Nominal (Rp)</th>
                            <th class="px-3 py-3 w-[20%] text-center">Status</th>
                            <th class="px-3 py-3 w-[5%] text-center"></th>
                        </tr>
                    </thead>
                    <tbody id="inputListBody" class="divide-y divide-slate-100 bg-white">
                        <!-- Rows injected via JS -->
                    </tbody>
                </table>
            </div>

            <button onclick="generateDashboard()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3.5 px-6 rounded-lg shadow-lg shadow-emerald-200 transition transform active:scale-[0.98] flex justify-center items-center gap-2 text-lg">
                <i class="ph ph-chart-pie-slice text-2xl"></i> Lihat Dashboard
            </button>
        </div>
    </section>

    <!-- ======================================================================= -->
    <!-- RESULT SECTION (DASHBOARD OUTPUT) -->
    <!-- ======================================================================= -->
    <section id="resultSection" class="w-full max-w-6xl hidden-section pb-20">
        
        <!-- Toolbar -->
        <div class="flex justify-center gap-4 mb-8">
            <button onclick="backToInput()" class="text-slate-600 hover:text-slate-900 bg-white border border-slate-300 font-medium px-5 py-2.5 rounded-full shadow-sm transition flex items-center gap-2">
                <i class="ph ph-pencil-simple"></i> Edit Data
            </button>
            <button onclick="downloadPNG()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-6 py-2.5 rounded-full shadow-lg shadow-blue-200 transition transform hover:-translate-y-0.5 flex items-center gap-2">
                <i class="ph ph-download-simple font-bold"></i> Download PNG
            </button>
        </div>

        <!-- CANVAS CAPTURE -->
        <div id="dashboard-container" class="capture-area relative bg-white shadow-2xl mx-auto max-w-[1000px]">
            <!-- Header Laporan -->
            <div class="flex justify-between items-end border-b-2 border-slate-800 pb-6 mb-6">
                <div>
                    <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">Laporan Keuangan</h2>
                    <p class="text-slate-500 mt-1 text-sm font-medium uppercase tracking-wide">Monitoring Cashflow</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-slate-500 font-semibold">Periode:</div>
                    <div id="displayPeriod" class="text-lg font-bold text-emerald-600">...</div>
                </div>
            </div>

            <!-- Cash Flow Summary Section -->
            <div class="bg-slate-800 text-white rounded-xl mb-8 shadow-lg border border-slate-700 overflow-hidden">
                <!-- Row 1: Realitas Saat Ini (Dana & Sisa Saldo) -->
                <div class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-slate-600 bg-slate-800/50">
                    <div class="p-5 text-center md:text-left">
                        <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">1. Total Dana Tersedia</div>
                        <div id="valTotalFunds" class="text-xl font-bold text-white">Rp 0</div>
                        <div class="text-[9px] text-slate-500 mt-1">Awal + Tambahan</div>
                    </div>
                    <div class="p-5 text-center">
                        <div class="text-[10px] text-amber-400 uppercase font-bold tracking-wider mb-1">2. Sudah Dibayar (Keluar)</div>
                        <div id="valTotalPaidReal" class="text-xl font-bold text-amber-400">Rp 0</div>
                        <div class="text-[9px] text-slate-500 mt-1">Lunas + Cicilan</div>
                    </div>
                    <div class="p-5 text-center md:text-right bg-emerald-900/30">
                        <div class="text-[10px] text-emerald-400 uppercase font-bold tracking-wider mb-1">3. Sisa Saldo (Cash)</div>
                        <div id="valRealBalance" class="text-2xl font-extrabold text-emerald-400">Rp 0</div>
                        <div class="text-[9px] text-emerald-600/70 mt-1 font-semibold">Dana - Terbayar</div>
                    </div>
                </div>

                <!-- Row 2: Proyeksi (Hutang & Estimasi Akhir) -->
                <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-600 border-t border-slate-600 bg-slate-900/50">
                    <div class="p-4 flex justify-between items-center px-6">
                        <div class="text-left">
                            <div class="text-[10px] text-rose-400 uppercase font-bold tracking-wider">Sisa Tagihan (Hutang)</div>
                            <div class="text-[9px] text-slate-500">Kewajiban yang belum lunas</div>
                        </div>
                        <div id="valRemainingDebt" class="text-xl font-bold text-rose-400">Rp 0</div>
                    </div>
                    <div class="p-4 flex justify-between items-center px-6">
                        <div class="text-left">
                            <div class="text-[10px] text-blue-400 uppercase font-bold tracking-wider">Estimasi Sisa Akhir</div>
                            <div class="text-[9px] text-slate-500">Jika semua hutang dilunasi</div>
                        </div>
                        <div class="text-right">
                            <div id="valProjectedFinal" class="text-xl font-bold text-blue-400">Rp 0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
                    <div class="text-[10px] font-bold text-slate-500 uppercase">Total Nominal Tagihan</div>
                    <div id="valTotalMoney" class="text-xl font-bold text-slate-800 truncate">Rp 0</div>
                </div>
                <div class="p-4 rounded-xl bg-emerald-50 border border-emerald-100">
                    <div class="text-[10px] font-bold text-emerald-700 uppercase">Sudah Lunas</div>
                    <div id="valYesMoney" class="text-xl font-bold text-emerald-700 truncate">Rp 0</div>
                </div>
                <div class="p-4 rounded-xl bg-amber-50 border border-amber-100">
                    <div class="text-[10px] font-bold text-amber-700 uppercase">Bayar Sebagian</div>
                    <div id="valPaidPartial" class="text-xl font-bold text-amber-700 truncate">Rp 0</div>
                </div>
                <div class="p-4 rounded-xl bg-rose-50 border border-rose-100">
                    <div class="text-[10px] font-bold text-rose-700 uppercase">Sisa Tagihan</div>
                    <div id="valNoMoney" class="text-xl font-bold text-rose-700 truncate">Rp 0</div>
                </div>
            </div>

            <!-- Content -->
            <div class="flex flex-col md:flex-row gap-8">
                <div class="w-full md:w-4/12">
                    <div style="position: relative; height:300px; width:100%;">
                        <canvas id="moneyChart"></canvas>
                    </div>
                    <div class="mt-4 text-center">
                         <div id="balanceStatus" class="inline-block px-4 py-2 rounded-lg text-xs font-bold bg-slate-100 text-slate-600">
                            Status Keuangan
                        </div>
                    </div>
                </div>
                <div class="w-full md:w-8/12">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="border-b-2 border-slate-100">
                                <th class="text-left py-2">Keterangan</th>
                                <th class="text-right py-2">Nominal Asli</th>
                                <th class="text-right py-2">Sudah Dibayar</th>
                                <th class="text-right py-2">Sisa</th>
                            </tr>
                        </thead>
                        <tbody id="resultTableBody" class="divide-y divide-slate-50"></tbody>
                        <tfoot class="border-t-2 border-slate-800">
                            <tr>
                                <td class="py-3 font-bold">TOTAL</td>
                                <td class="py-3 text-right font-mono text-slate-500" id="tableTotalOriginal">Rp 0</td>
                                <td class="py-3 text-right font-mono text-amber-600" id="tableTotalPaid">Rp 0</td>
                                <td class="py-3 text-right font-mono font-bold text-rose-600" id="tableTotalRemaining">Rp 0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
             <!-- Footer -->
             <div class="mt-10 pt-4 border-t border-slate-100 flex justify-between items-end text-[10px] text-slate-400">
                <p>Generated automatically</p>
                <p id="printTime">...</p>
            </div>
        </div>

    </section>

    <!-- JAVASCRIPT SYSTEM (CORE) -->
    <script>
        // KUNCI PENYIMPANAN: 
        // Menggunakan versi baru untuk memastikan format data sesuai
        const STORAGE_KEY = 'MyFinance_InputData_V11'; 
        let saveTimeout;
        let chartInstance;

        // --- FUNGSI TAMPILKAN INDIKATOR ---
        function showIndicator(message = "Disimpan otomatis...", isRecovery = false) {
            const el = document.getElementById('saveIndicator');
            const txt = document.getElementById('saveText');
            
            txt.innerText = message;
            
            if(isRecovery) {
                // Style khusus untuk pesan pemulihan data
                el.style.backgroundColor = "rgba(59, 130, 246, 0.9)"; // Biru
            } else {
                // Style normal (simpan)
                el.style.backgroundColor = "rgba(16, 185, 129, 0.9)"; // Hijau
            }

            el.classList.add('visible');

            // Jika bukan recovery (alias simpan biasa), hilangkan setelah 1 detik
            // Jika recovery, biarkan sedikit lebih lama (2.5 detik) agar terbaca
            const delay = isRecovery ? 2500 : 800;
            
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                el.classList.remove('visible');
            }, delay);
        }

        // --- FUNGSI LOAD (AUTOLOAD) ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedData = localStorage.getItem(STORAGE_KEY);
            const today = new Date().toISOString().split('T')[0];
            
            // Helper binding untuk input uang
            const bindMoneyInput = (id) => {
                const el = document.getElementById(id);
                if(el) {
                    el.addEventListener('input', function() {
                        let raw = this.value.replace(/\D/g, '');
                        this.value = raw ? new Intl.NumberFormat('id-ID').format(raw) : '';
                        saveData();
                    });
                }
            };
            bindMoneyInput('currentFunds');
            bindMoneyInput('incomingFunds');

            if (savedData) {
                // JIKA ADA DATA TERSIMPAN
                try {
                    const parsed = JSON.parse(savedData);
                    document.getElementById('startDate').value = parsed.startDate || today;
                    document.getElementById('endDate').value = parsed.endDate || today;
                    document.getElementById('currentFunds').value = parsed.currentFunds || '';
                    document.getElementById('incomingFunds').value = parsed.incomingFunds || '';
                    
                    // Kosongkan body table dulu sebelum append
                    document.getElementById('inputListBody').innerHTML = '';

                    if (parsed.items && parsed.items.length > 0) {
                        parsed.items.forEach(item => {
                            createRow(item.name, item.nominal, item.status, item.paidAmount, item.category, item.date);
                        });
                        
                        // Tampilkan Notifikasi Data Kembali
                        setTimeout(() => {
                            showIndicator(`üìÇ ${parsed.items.length} Data berhasil dipulihkan!`, true);
                        }, 500);

                    } else {
                        createRow();
                    }
                } catch (e) {
                    console.error("Gagal load data", e);
                    createRow();
                }
            } else {
                // DATA BARU / KOSONG
                document.getElementById('startDate').value = today;
                document.getElementById('endDate').value = today;
                createRow();
            }

            // Pasang Global Listeners untuk field non-dinamis
            document.getElementById('startDate').addEventListener('change', saveData);
            document.getElementById('endDate').addEventListener('change', saveData);
            document.getElementById('btnAddRow').addEventListener('click', () => createRow());
        });

        // --- FUNGSI SIMPAN (AUTOSAVE) ---
        function saveData() {
            showIndicator("Disimpan otomatis...");

            const items = [];
            // Ambil data visual dari tabel
            document.querySelectorAll('#inputListBody tr').forEach(row => {
                const status = row.querySelector('.inp-status').value;
                let paidAmt = row.querySelector('.inp-partial').value;
                
                if (status === 'Belum') paidAmt = ''; 
                
                items.push({
                    name: row.querySelector('.inp-name').value,
                    date: row.querySelector('.inp-date').value,
                    category: row.querySelector('.inp-category').value,
                    nominal: row.querySelector('.inp-nominal').value,
                    status: status,
                    paidAmount: paidAmt
                });
            });

            const dataToSave = {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                currentFunds: document.getElementById('currentFunds').value,
                incomingFunds: document.getElementById('incomingFunds').value,
                items: items
            };

            // Simpan ke Browser Storage
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
        }

        // --- FUNGSI CREATE ROW ---
        function createRow(nameVal = '', nominalVal = '', statusVal = 'Belum', paidVal = '', categoryVal = 'Operational', dateVal = '') {
            const tbody = document.getElementById('inputListBody');
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 transition align-top group";
            
            tr.innerHTML = `
                <td class="px-3 py-3 align-middle text-center">
                    <div class="flex flex-col gap-1 items-center">
                         <button class="btn-up p-1 text-slate-300 hover:text-emerald-500 hover:bg-emerald-50 rounded transition" title="Geser Naik">
                            <i class="ph ph-caret-up text-sm font-bold"></i>
                        </button>
                        <button class="btn-down p-1 text-slate-300 hover:text-emerald-500 hover:bg-emerald-50 rounded transition" title="Geser Turun">
                            <i class="ph ph-caret-down text-sm font-bold"></i>
                        </button>
                    </div>
                </td>
                <td class="px-3 py-3">
                    <input type="date" class="inp-date w-full p-2 border border-slate-200 rounded focus:border-emerald-500 outline-none text-xs bg-white text-slate-600">
                </td>
                <td class="px-3 py-3">
                    <input type="text" class="inp-name w-full p-2 border border-slate-200 rounded focus:border-emerald-500 outline-none placeholder-slate-400 font-medium" placeholder="Nama Transaksi...">
                </td>
                <td class="px-3 py-3">
                    <select class="inp-category w-full p-2 border border-slate-200 rounded focus:border-emerald-500 outline-none text-xs bg-white">
                        <option value="Vendor">Vendor (Produksi)</option>
                        <option value="Operational">Operational</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Creative">Creative</option>
                    </select>
                </td>
                <td class="px-3 py-3">
                    <input type="text" class="inp-nominal w-full p-2 border border-slate-200 rounded focus:border-emerald-500 outline-none text-right font-mono font-semibold" placeholder="0">
                </td>
                <td class="px-3 py-3 text-center">
                    <div class="flex flex-col gap-1">
                        <select class="inp-status w-full p-2 border border-slate-200 rounded focus:border-emerald-500 outline-none text-sm">
                            <option value="Belum">‚ùå Belum Bayar</option>
                            <option value="Sebagian">‚ö†Ô∏è Bayar Sebagian</option>
                            <option value="Lunas">‚úÖ Lunas Full</option>
                        </select>
                        <div class="partial-container bg-amber-50 rounded border border-amber-200 px-2">
                            <input type="text" class="inp-partial w-full bg-transparent p-1 text-xs text-center font-mono text-amber-800 outline-none placeholder-amber-400" placeholder="Rp Dibayar..." value="${paidVal}">
                        </div>
                    </div>
                </td>
                <td class="px-3 py-3 text-center align-middle">
                    <button class="btn-del text-slate-300 hover:text-rose-500 p-2 rounded hover:bg-rose-50 transition" title="Hapus"><i class="ph ph-trash text-lg"></i></button>
                </td>
            `;

            // Element Selectors
            const iName = tr.querySelector('.inp-name');
            const iDate = tr.querySelector('.inp-date');
            const iCategory = tr.querySelector('.inp-category');
            const iNominal = tr.querySelector('.inp-nominal');
            const iStatus = tr.querySelector('.inp-status');
            const iPartial = tr.querySelector('.inp-partial');
            const partialContainer = tr.querySelector('.partial-container');
            const btnDel = tr.querySelector('.btn-del');
            const btnUp = tr.querySelector('.btn-up');
            const btnDown = tr.querySelector('.btn-down');

            // Set Values
            iName.value = nameVal;
            iDate.value = dateVal;
            iCategory.value = categoryVal || 'Operational';
            iNominal.value = nominalVal;
            iStatus.value = statusVal;

            // Partial Toggle Logic
            const togglePartial = () => {
                if (iStatus.value === 'Sebagian') {
                    partialContainer.classList.add('show');
                } else {
                    partialContainer.classList.remove('show');
                }
            };
            togglePartial();

            // Format Money Helper
            const formatMoney = (el) => {
                let raw = el.value.replace(/\D/g, '');
                el.value = raw ? new Intl.NumberFormat('id-ID').format(raw) : '';
                saveData();
            };

            // Event Listeners (Untuk Memicu Autosave)
            iName.addEventListener('input', saveData);
            iDate.addEventListener('change', saveData); // Change lebih aman untuk date picker
            iCategory.addEventListener('change', saveData);
            iStatus.addEventListener('change', () => { togglePartial(); saveData(); });
            iNominal.addEventListener('input', function() { formatMoney(this); });
            iPartial.addEventListener('input', function() { formatMoney(this); });

            // Button Actions
            btnDel.addEventListener('click', () => { tr.remove(); saveData(); });

            // Move Logic
            btnUp.addEventListener('click', () => {
                if (tr.previousElementSibling) {
                    tbody.insertBefore(tr, tr.previousElementSibling);
                    saveData();
                }
            });
            btnDown.addEventListener('click', () => {
                if (tr.nextElementSibling) {
                    tbody.insertBefore(tr.nextElementSibling, tr);
                    saveData();
                }
            });

            tbody.appendChild(tr);
        }

        function resetEverything() {
            if(confirm("Yakin ingin menghapus semua data tersimpan? Ini tidak bisa dibatalkan.")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // --- DASHBOARD LOGIC ---
        const formatIDR = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
        const parseMoney = (str) => parseInt((str || '0').replace(/\D/g, '')) || 0;
        
        const formatDateDisplay = (dateStr) => {
            if(!dateStr) return '';
            const opts = { day: 'numeric', month: 'short' };
            return new Date(dateStr).toLocaleDateString('id-ID', opts);
        };

        function generateDashboard() {
            // Ambil Data Langsung dari Storage agar konsisten
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
            const items = data.items || [];
            
            const currentF = parseMoney(data.currentFunds);
            const incomingF = parseMoney(data.incomingFunds);
            const totalFunds = currentF + incomingF;

            let totalOriginalBill = 0; 
            let totalPaidReal = 0;     
            let totalRemainingDebt = 0;
            
            let chartLunas = 0;
            let chartSebagianSisa = 0;
            let chartBelum = 0;

            const tableBody = document.getElementById('resultTableBody');
            tableBody.innerHTML = '';
            
            if (items.length === 0 && currentF === 0 && incomingF === 0) { alert("Data kosong! Silakan isi dulu."); return; }

            items.forEach(item => {
                if(!item.name) return;
                const nominal = parseMoney(item.nominal);
                let paid = 0;
                let remaining = 0;

                if (item.status === 'Lunas') {
                    paid = nominal;
                    remaining = 0;
                    chartLunas += nominal;
                } else if (item.status === 'Belum') {
                    paid = 0;
                    remaining = nominal;
                    chartBelum += nominal;
                } else if (item.status === 'Sebagian') {
                    paid = parseMoney(item.paidAmount);
                    if (paid > nominal) paid = nominal;
                    remaining = nominal - paid;
                    chartSebagianSisa += remaining; 
                }

                totalOriginalBill += nominal;
                totalPaidReal += paid;
                totalRemainingDebt += remaining;

                // Render Styling
                let rowClass = '';
                if(item.status === 'Lunas') rowClass = 'bg-emerald-50/30';
                else if(item.status === 'Belum') rowClass = 'bg-rose-50/30';
                else rowClass = 'bg-amber-50/30';

                // Category Badge
                let catColor = 'bg-slate-100 text-slate-600';
                if(item.category === 'Vendor') catColor = 'bg-indigo-100 text-indigo-700';
                if(item.category === 'Operational') catColor = 'bg-cyan-100 text-cyan-700';
                if(item.category === 'Marketing') catColor = 'bg-pink-100 text-pink-700';
                if(item.category === 'Creative') catColor = 'bg-purple-100 text-purple-700';

                const dateDisplay = item.date ? `<span class="text-[10px] text-slate-400 font-mono ml-1"><i class="ph ph-calendar"></i> ${formatDateDisplay(item.date)}</span>` : '';

                tableBody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="py-2 pl-2">
                            <div class="font-medium text-slate-800 flex items-center gap-2">
                                ${item.name} 
                            </div>
                            <div class="mt-1 flex items-center gap-2">
                                <span class="inline-block px-1.5 py-0.5 rounded text-[9px] font-bold uppercase tracking-wide ${catColor}">${item.category}</span>
                                ${dateDisplay}
                            </div>
                        </td>
                        <td class="py-2 text-right font-mono text-slate-500 align-top pt-2.5">${formatIDR(nominal)}</td>
                        <td class="py-2 text-right font-mono text-amber-700 font-semibold align-top pt-2.5">${paid > 0 ? formatIDR(paid) : '-'}</td>
                        <td class="py-2 text-right font-mono font-bold text-rose-600 align-top pt-2.5">${remaining > 0 ? formatIDR(remaining) : '<i class="ph ph-check text-emerald-600"></i>'}</td>
                    </tr>
                `;
            });

            // --- SUMMARY UPDATES ---
            const realBalance = totalFunds - totalPaidReal; 
            const projectedFinal = realBalance - totalRemainingDebt;

            document.getElementById('valTotalFunds').innerText = formatIDR(totalFunds);
            document.getElementById('valTotalPaidReal').innerText = formatIDR(totalPaidReal);
            document.getElementById('valRealBalance').innerText = formatIDR(realBalance);
            
            document.getElementById('valRemainingDebt').innerText = formatIDR(totalRemainingDebt);
            document.getElementById('valProjectedFinal').innerText = formatIDR(projectedFinal);

            document.getElementById('valTotalMoney').innerText = formatIDR(totalOriginalBill);
            document.getElementById('valYesMoney').innerText = formatIDR(chartLunas);
            document.getElementById('valPaidPartial').innerText = formatIDR(totalPaidReal - chartLunas);
            document.getElementById('valNoMoney').innerText = formatIDR(totalRemainingDebt);
            
            document.getElementById('tableTotalOriginal').innerText = formatIDR(totalOriginalBill);
            document.getElementById('tableTotalPaid').innerText = formatIDR(totalPaidReal);
            document.getElementById('tableTotalRemaining').innerText = formatIDR(totalRemainingDebt);

            const balEl = document.getElementById('balanceStatus');
            if(projectedFinal >= 0) {
                balEl.className = "inline-block px-4 py-2 rounded-lg text-sm font-bold bg-emerald-100 text-emerald-800 border border-emerald-200";
                balEl.innerHTML = `<i class="ph ph-check-circle"></i> Keuangan Aman (Surplus)`;
            } else {
                balEl.className = "inline-block px-4 py-2 rounded-lg text-sm font-bold bg-rose-100 text-rose-800 border border-rose-200";
                balEl.innerHTML = `<i class="ph ph-warning-circle"></i> Waspada: Defisit ${formatIDR(Math.abs(projectedFinal))}`;
            }

            renderChart(chartLunas + (totalPaidReal - chartLunas), chartSebagianSisa, chartBelum);
            
            const d1 = document.getElementById('startDate').value;
            const d2 = document.getElementById('endDate').value;
            document.getElementById('displayPeriod').innerText = `${d1} s/d ${d2}`;
            document.getElementById('printTime').innerText = new Date().toLocaleString();

            document.getElementById('inputSection').classList.add('hidden-section');
            document.querySelector('header').classList.add('hidden-section');
            document.getElementById('resultSection').classList.remove('hidden-section');
            window.scrollTo(0,0);
        }

        function backToInput() {
            document.getElementById('resultSection').classList.add('hidden-section');
            document.getElementById('inputSection').classList.remove('hidden-section');
            document.querySelector('header').classList.remove('hidden-section');
        }

        function renderChart(totalPaid, sisaCicilan, fullBelum) {
            const ctx = document.getElementById('moneyChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Sudah Dibayar (Lunas+Cicil)', 'Sisa Kewajiban Cicilan', 'Belum Dibayar'],
                    datasets: [{
                        data: [totalPaid, sisaCicilan, fullBelum],
                        backgroundColor: ['#10b981', '#f59e0b', '#f43f5e'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function downloadPNG() {
            html2canvas(document.getElementById('dashboard-container'), {scale: 2}).then(c => {
                const a = document.createElement('a');
                a.download = 'Laporan_Keuangan.png';
                a.href = c.toDataURL();
                a.click();
            });
        }
    </script>
</body>
</html>